window.Cedar=window.Cedar||{},window.Cedar=$.extend({},window.Cedar,{initialized:!1,store:null,admin:null}),window.Cedar.config=window.Cedar.config||{},Cedar.Init=function(e){return new Cedar.Application(e)},Cedar.debug=function(e){Cedar.config.debug&&window.console.log(e)},Cedar.Application=function(e){if(!Cedar.initialized){var t={debug:!1,fetch:!0,wait:!1,allowUnsecured:!1,objectNameFilter:"",liveMode:!0,initHTML:!1,inlineEditing:!1};if(this.options=$.extend({},$.extend({},t,window.Cedar.config),e),void 0===this.options.server)throw'Cedar Error: must provide "server" value on Init()';Cedar.config.server=this.getProtocol()+this.options.server,Cedar.config.api=this.getProtocol()+this.options.server+"/api",Cedar.config.debug=this.options.debug,Cedar.config.wait=this.options.wait,Cedar.config.fetch=this.options.fetch,Cedar.config.objectNameFilter=this.options.objectNameFilter,Cedar.config.liveMode=this.options.liveMode,Cedar.config.initHTML=this.options.initHTML,Cedar.config.inlineEditing=this.options.inlineEditing,void 0===Cedar.events&&(Cedar.events=new Cedar.Events),null===Cedar.store&&(Cedar.store=new Cedar.Store),null===Cedar.admin&&(Cedar.admin=new Cedar.Admin),Cedar.initialized=!0,Cedar.config.initHTML&&this.initializeHTML()}},Cedar.Application.prototype.initializeHTML=function(){$("[data-cedar-id]").each(function(){var e=$(this);e.data("cedarObject",new Cedar.ContentEntry({el:this,cedarId:e.data("cedarId")})),Cedar.events.on("content:loaded",function(){e.data("cedarObject").render()}.bind(this))}),Cedar.events.trigger("content:loaded")},Cedar.Application.prototype.getProtocol=function(){return this.options.allowUnsecured&&"http:"===window.location.protocol?"http://":"https://"},Cedar.Events=function(){this.eventCollection={}},Cedar.Events.prototype.trigger=function(e){this.eventCollection[e]||(this.eventCollection[e]=document.createEvent("Event"),this.eventCollection[e].initEvent(e,!0,!0)),document.dispatchEvent(this.eventCollection[e])},Cedar.Events.prototype.on=function(e,t){document.addEventListener(e,t)},Cedar.Store=function(){this.loaded=!1;var e,t;try{t=new Date,(this.cache=window.localStorage).setItem(t,t),e=this.cache.getItem(t)!=t,this.cache.removeItem(t),e&&(this.cache=!1)}catch(n){this.cache={}}Cedar.config.fetch&&this.refresh()},Cedar.Store.prototype.formattedType=function(e){return"cedar_"+s(_(e).pluralize()).underscored().value()},Cedar.Store.prototype.putCollection=function(e,t){var n=this.formattedType(e);this.cache[n]=JSON.stringify(t)},Cedar.Store.prototype.get=function(e,t){return this.getDeferred(this.formattedType(e),t).then(function(e){try{return JSON.parse(e)}catch(t){return e}})},Cedar.Store.prototype.cachedObject=function(e,t){var n,i=this.cache[e]&&JSON.parse(this.cache[e])||[];return n=t&&t.hasOwnProperty("id")?_.findWhere(i,t):_.where(i,t)},Cedar.Store.prototype.getDeferred=function(e,t){var n=this.cachedDeferred(e,t),i=this.remoteDeferred(e,t);return Cedar.config.wait||_(this.cachedObject(e,t)).isEmpty()?(Cedar.config.liveMode&&Cedar.debug("checking remote: "+e+"/"+JSON.stringify(t)),i):(Cedar.debug("get from cache: "+e+"/"+JSON.stringify(t)),n)},Cedar.Store.prototype.cachedDeferred=function(e,t){return $.Deferred().resolve(this.cachedObject(e,t))},Cedar.Store.prototype.remoteDeferred=function(e,t){return this.refresh().then(function(){return this.cachedDeferred(e,t)}.bind(this))},Cedar.Store.prototype.refresh=function(){return this.checkVersion().then(function(){return this.loaded?$.Deferred().resolve():this.getRemote()}.bind(this))},Cedar.Store.prototype.getRemote=function(e){var t={path:"/queries/all/"};e=$.extend({},t,e);var n={},i=$.extend({},n,{filter:Cedar.config.objectNameFilter,references:"all",expand:"yes"});return this.lockedRequest({path:e.path,params:i,success:function(e){_.each(e,function(e,t){this.putCollection(t,e),Cedar.debug("storing: "+t)}.bind(this)),Cedar.debug("local storage was updated"),this.loaded=!0,Cedar.events.trigger("content:loaded")}.bind(this)})},Cedar.Store.prototype.clear=function(e){void 0===e?window.hasOwnProperty("localStorage")?this.cache.clear():this.cache={}:delete this.cache[e]},Cedar.Store.prototype.setVersion=function(e){Cedar.debug("updating to version #"+e),this.cache.___CEDAR__DATA__FINGERPRINT___=e},Cedar.Store.prototype.getVersion=function(){return this.cache.___CEDAR__DATA__FINGERPRINT___},Cedar.Store.prototype.checkVersion=function(){return this.lockedRequest({path:"/queries/status",success:function(e){Cedar.debug("checking version #"+this.getVersion()),this.getVersion()!==e.settings.version.toString()?(Cedar.debug("setting version: "+e.settings.version),this.loaded=!1,this.setVersion(e.settings.version)):(Cedar.debug("version is up to date"),this.loaded=!0,Cedar.events.trigger("content:loaded"))}.bind(this)})},Cedar.Store.prototype.lockedRequest=function(e){if(e=e||{},Cedar.config.liveMode){this.requestCache||(this.requestCache={});var t=JSON.stringify({path:e.path,params:e.params});return this.requestCache[t]||(this.requestCache[t]=$.getJSON(Cedar.config.api+e.path,e.params).then(function(t){e.success(t)}.bind(this)))}return $.Deferred().resolve()},Cedar.ContentObject=function(e){var t={cedarType:"ContentEntry",el:"<div />"};this.options=$.extend({},t,e),this.$el=$(this.options.el)},Cedar.ContentObject.prototype={render:function(){this.load().then(function(){this.$el.html(this.toString())}.bind(this))},load:function(){return Cedar.store.get(this.options.cedarType,this.options.cedarId).then(function(e){return this.setContent(e),this}.bind(this))},getContent:function(){return this.content||this.options.defaultContent||""},setContent:function(e){this.content=e||""},getContentWithEditTools:function(){return this.getEditOpen()+this.getContent()+this.getEditClose()},toString:function(){return Cedar.admin.isEditMode()?this.getContentWithEditTools():this.getContent()},toJSON:function(){return _.chain(this.content).pairs().map(function(e){return[s.camelize(e[0]),e[1]]}).object().value()},getEditOpen:function(){return'<span data-cedar-type="'+this.options.cedarType+'" data-cedar-id="'+this.options.cedarId+'" >'},getEditClose:function(){return"</span>"}},Cedar.ContentObject.prototype.constructor=Cedar.ContentObject,Cedar.ContentEntry=function(e){Cedar.ContentObject.call(this,e)},Cedar.ContentEntry.prototype=Object.create(Cedar.ContentObject.prototype),Cedar.ContentEntry.prototype.constructor=Cedar.ContentEntry,Cedar.ContentEntry.prototype.setContent=function(e){this.content=e&&e.content||e&&e.settings&&e.settings.content||""},Cedar.ContentEntry.prototype.toJSON=function(e){return{content:this.getContent()}};
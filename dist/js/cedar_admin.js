window.Cedar=window.Cedar||{},Cedar.Admin=function(){this.isEditMode()&&this.toolbar(),this.scanDOM(),this.observeDOM("body",_.bind(function(){this.scanDOM()},this))},Cedar.Admin.prototype.scanDOM=function(){var e="cedar-cms-editable";this.isEditMode()&&$("[data-cedar-type]").each(_.bind(function(i,n){var t=$(n);if(!t.hasClass(e)){var a=$(this.getEditTools(t.data()));t.prepend(a),t.addClass(e+" clearfix"),Cedar.config.inlineEditing&&t.find(".cedar-js-edit").on("click",_.bind(this.loadIframeSrc,this))}},this))},Cedar.Admin.prototype.observeDOM=function(e,i){var n=window.MutationObserver||window.WebKitMutationObserver;if(n){var t=new n(function(n,t){(n[0].addedNodes.length||n[0].removedNodes.length)&&(t.disconnect(),i(),t.observe($(e)[0],{childList:!0,subtree:!0}))});t.observe($(e)[0],{childList:!0,subtree:!0})}},Cedar.Admin.prototype.loadIframeSrc=function(e){e.preventDefault(),this.$adminIframe.on("load",_.bind(function(){$(this.$adminIframe).off("load"),$(this.$adminIframe).on("load",_.bind(function(e){window.location.reload(!0)},this));var e=this.$adminIframe.contents(),i=e.find("#editForm");e.find(".cms-dashboard").hide(),e.find("#cmsToolbarPlaceholder").hide(),i.on("submit",_.bind(function(e){this.$iframeContainer.hide()},this)),i.find(".s-cancel-edit").on("click",_.bind(this.hideIframe,this)),this.$iframeContainer.show()},this)),this.$adminIframe.attr("src",e.currentTarget.href)},Cedar.Admin.prototype.isEditMode=function(){return this.hasEditModeCookie()||this.hasEditModeUrl()},Cedar.Admin.prototype.hasEditModeUrl=function(){for(var e=window.location.search.substring(1),i=e.split("&"),n=0;n<i.length;){if("cdrlogin"===i[n])return document.cookie="cedarEditMode=",!0;n++}return!1},Cedar.Admin.prototype.hasEditModeCookie=function(){return new RegExp("(?:^|;\\s*)cedarEditMode\\s*\\=").test(document.cookie)},Cedar.Admin.prototype.toolbar=function(e){$(document).ready(_.bind(function(){this.$body=$("body");var e='<div class="cedar-cms-global-actions"><a class="cedar-cms-global-action js-cedar-cms-log-off" href="#"><span class="cedar-cms-icon cedar-cms-icon-nav"></span> <span class="cedar-cms-global-action-label">Log Off</span></a></div>';this.$body.append(e),this.$body.addClass("cedar-cms-logged-in"),$(".js-cedar-cms-log-off").on("click",_.bind(function(e){this.logOff(e)},this)),Cedar.config.inlineEditing&&this.renderIframe()},this))},Cedar.Admin.prototype.renderIframe=function(){$(document).ready(_.bind(function(){var e=$(".cedar-cms-global-actions"),i=$('<a class="cedar-cms-global-action js-cedar-cms-close-iframe" href="#"><span class="cedar-cms-global-action-label">Close</span></a>');i.on("click",_.bind(this.hideIframe,this)),this.$iframeContainer=$('<div class="cedar-cms-admin-iframe-container"></div>'),this.$adminIframe=$('<iframe class="cedar-cms-admin-iframe" id="cedar-cms-admin-iframe"></iframe>'),this.$iframeContainer.append(i),this.$iframeContainer.append(this.$adminIframe),e.append(this.$iframeContainer),this.$iframeContainer.hide()},this))},Cedar.Admin.prototype.hideIframe=function(){$(this.$adminIframe).off("load"),this.$iframeContainer.hide()},Cedar.Admin.prototype.logOff=function(e){e.preventDefault(),document.cookie="cedarEditMode=; expires=Thu, 01 Jan 1970 00:00:00 GMT",location.href===this.getLogOffURL()?location.reload(!0):window.location.href=this.getLogOffURL()},Cedar.Admin.prototype.getLogOffURL=function(){return this.removeURLParameter(window.location.href,"cdrlogin")},Cedar.Admin.prototype.getEditLink=function(e){var i=Cedar.config.server+"/cmsadmin/";return i+="ContentEntry"===e.cedarType?"Edit":"Select",i+="Data?cdr=1&t="+e.cedarType+"&o="+encodeURIComponent(e.cedarId),i+="&referer="+encodeURIComponent(window.location.href)},Cedar.Admin.prototype.getEditTools=function(e){var i="ContentEntry"===e.cedarType?"edit":"list",n='<span class="cedar-cms-edit-tools">';return n+='<a href="'+this.getEditLink(e)+'" class="cedar-cms-edit-icon cedar-js-edit" >',n+='<i class="cedar-cms-icon cedar-cms-icon-right cedar-cms-icon-'+i+'"></i></a>',n+="</span>"},Cedar.Admin.prototype.removeURLParameter=function(e,i){var n=e.split("#"),t=n[0],a=n[1]||"";a&&(a="#"+a);var o=t.split("?");if(o.length>=2){for(var d=encodeURIComponent(i),r=o[1].split(/[&;]/g),s=r.length-1;s>=0;)-1!==r[s].lastIndexOf(d,0)&&r.splice(s,1),s--;var c=o[0];return r.length>0&&(c+="?"+r.join("&")),c+a}return e};